<script lang="ts">
	interface IconData {
		contents: string;
		attrs: {
			xmlns: string;
			width: number;
			height: number;
			viewBox: string;
			fill: string;
			stroke: string;
			'stroke-width': number;
			'stroke-linecap': 'inherit' | 'butt' | 'round' | 'square';
			'stroke-linejoin': 'inherit' | 'round' | 'miter' | 'bevel';
		};
	}

	export let icon: IconData | Promise<IconData> | (() => Promise<IconData>);

	export let label = '';
	export let style = '';
	export let girth: string | number = 1.5;
	export let scale: string | number = 1.5;
	export let flip: undefined | 'x' | 'y' = undefined;
	export { className as class };
	let className = '';

	function scope<T>(fn: () => T) {
		return fn();
	}
</script>

{#await typeof icon === 'function' ? icon() : icon}
	<slot name="loading" />
{:then { attrs, contents }}
	{@const { width, height } = scope(() => {
		const { width: w, height: h } = attrs;
		const ratio = Math.max(w, h) / 16 || 1;
		return {
			width: +scale * (w / ratio),
			height: +scale * (h / ratio),
		};
	})}
	{@const data = Object.assign(attrs, {
		style,
		width,
		height,
		'aria-label': label || null,
		'stroke-width': girth,
		role: label ? 'img' : 'presentation',
		class: className || null,
	})}

	<svg {...data} style:transform={flip ? `scale${{ x: 'Y', y: 'X' }[flip]}(-1)` : ''}>
		{@html contents}
	</svg>
{:catch error}
	<slot name="error">
		<pre>{JSON.stringify(error)}</pre>
	</slot>
{/await}
